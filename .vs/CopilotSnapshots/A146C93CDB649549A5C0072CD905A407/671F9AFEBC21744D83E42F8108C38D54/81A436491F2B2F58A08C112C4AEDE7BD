/**
 * UserManagement.jsx - Quản lý người dùng
 * 
 * Chức năng:
 * - Xem danh sách người dùng
 * - Thêm/sửa/xóa người dùng
 * - Phân quyền và vai trò
 * - Kích hoạt/vô hiệu hóa tài khoản
 */

import { useState, useEffect } from 'react';
import { useApp } from '../hooks/useApp';
import { generateId } from '../utils/config';
import Modal from './Modal';
import { fetchUsers, createUser, updateUser, deleteUser, toggleUserStatus } from '../services/users';

export default function UserManagement({ user }) {
  const [users, setUsers] = useState([]);
  const [btcGroups, setBtcGroups] = useState([]);
  const [eventsList, setEventsList] = useState([]);
  const [page, setPage] = useState(1);
  const itemsPerPage = 10;
  const [showModal, setShowModal] = useState(false);
  const [showBtcModal, setShowBtcModal] = useState(false);
  const [editingGroup, setEditingGroup] = useState(null);
  const [editingUser, setEditingUser] = useState(null);
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    role: 'student',
    password: '',
    status: 'active'
  });

  const { state } = useApp();
  const { data, config } = state;

  const mapRoleFromNameOrId = (roleName, roleId) => {
    if (roleName) {
      const rn = (roleName || '').toLowerCase();
      if (rn.includes('admin')) return 'admin';
      if (rn.includes('bantochuc') || rn.includes('ban to chuc') || rn.includes('ban tổ chức')) return 'btc';
      if (rn.includes('canbolop') || rn.includes('can bo lop') || rn.includes('cán bộ lớp')) return 'cbl';
      if (rn.includes('sinhvien') || rn.includes('sinh viên')) return 'student';
      if (rn.includes('giamkhao') || rn.includes('giám khảo')) return 'judge';
    }
    if (roleId != null) {
      const id = Number(roleId);
      if (id === 1) return 'admin';
      if (id === 2) return 'btc';
      if (id === 3) return 'cbl';
      if (id === 4) return 'student';
      if (id === 5) return 'judge';
    }
    return 'student';
  };

  const roleToId = (role) => {
    switch (role) {
      case 'admin': return 1;
      case 'btc': return 2;
      case 'cbl': return 3;
      case 'student': return 4;
      case 'judge': return 5;
      default: return null;
    }
  };

  useEffect(() => {
    let mounted = true;

    const loadFromApi = async () => {
      try {
        const apiUsers = await fetchUsers();
        if (!apiUsers) return false;
        if (!mounted) return true;
        const mapped = apiUsers.map(u => ({
          id: u.id,
          type: 'user',
          name: u.username,
          email: u.email,
          role: mapRoleFromNameOrId(u.roleName, u.roleId),
          status: Number(u.active) === 1 ? 'active' : 'inactive',
          createdBy: '',
          createdAt: u.createdAt || new Date().toISOString(),
          updatedAt: u.createdAt || new Date().toISOString(),
          data: '{}'
        }));
        setUsers(mapped);
        return true;
      } catch (err) {
        // API not available or error - fallback to local
        return false;
      }
    };

    const initLocal = () => {
      const usersFromData = data.filter(item => item.type === 'user');
      // nếu không có data thật thì tạo demo 20 user tạm
      if (usersFromData.length === 0) {
        const demo = Array.from({ length: 20 }).map((_, i) => ({
          id: `demo-user-${i + 1}`,
          type: 'user',
          name: `Người dùng ${i + 1}`,
          email: `user${i + 1}@demo.test`,
          role: ['student', 'cbl', 'btc', 'judge', 'admin'][i % 5],
          status: i % 4 === 0 ? 'inactive' : 'active',
          createdBy: 'system',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          data: '{}'
        }));
        setUsers(demo);
      } else {
        setUsers(usersFromData);
      }
    };

    (async () => {
      if (user && user.role === 'admin') {
        const ok = await loadFromApi();
        if (!ok && mounted) initLocal();
      } else {
        initLocal();
      }

      const btcFromData = data.filter(item => item.type === 'btc_group');
      if (btcFromData.length === 0) {
        setBtcGroups([]);
      } else {
        setBtcGroups(btcFromData);
      }

      const eventsFromData = data.filter(item => item.type === 'event');
      // nếu không có sự kiện thật thì tạo 5 demo event (dùng cho select)
      if (eventsFromData.length === 0) {
        const demoEvents = Array.from({ length: 5 }).map((_, i) => ({
          id: `demo-event-${i + 1}`,
          type: 'event',
          title: `Sự kiện demo ${i + 1}`,
          description: `Mô tả sự kiện demo ${i + 1}`,
          startDate: new Date().toISOString(),
          endDate: new Date().toISOString(),
          location: `Địa điểm ${i + 1}`,
          maxParticipants: 100,
          currentParticipants: 0,
          status: 'draft',
          createdBy: 'system',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          data: '{}'
        }));
        setEventsList(demoEvents);
      } else {
        setEventsList(eventsFromData.slice(0, 5));
      }
    })();

    return () => { mounted = false; };
  }, [data, user]);

  const roleOptions = [
    { value: 'student', label: 'Sinh viên' },
    { value: 'cbl', label: 'Cán bộ lớp' },
    { value: 'btc', label: 'Ban tổ chức' },
    { value: 'judge', label: 'Ban giám khảo' },
    { value: 'admin', label: 'Quản trị viên' }
  ];

  const refreshApiUsers = async () => {
    try {
      const apiUsers = await fetchUsers();
      if (!apiUsers) return;
      const mapped = apiUsers.map(u => ({
        id: u.id,
        type: 'user',
        name: u.username,
        email: u.email,
        role: mapRoleFromNameOrId(u.roleName, u.roleId),
        status: Number(u.active) === 1 ? 'active' : 'inactive',
        createdBy: '',
        createdAt: u.createdAt || new Date().toISOString(),
        updatedAt: u.createdAt || new Date().toISOString(),
        data: '{}'
      }));
      setUsers(mapped);
    } catch (err) {
      // ignore
    }
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);

    const userData = {
      id: editingUser?.id || generateId(),
      type: 'user',
      name: formData.name,
      email: formData.email,
      role: formData.role,
      status: formData.status,
      createdBy: user.id,
      createdAt: editingUser?.createdAt || new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      data: JSON.stringify({
        ...formData,
        password: formData.password ? formData.password : undefined
      })
    };

    try {
      if (user && user.role === 'admin') {
        // Use API
        if (editingUser) {
          const body = {
            email: formData.email,
            roleId: roleToId(formData.role)
          };
          if (formData.password) body.password = formData.password;
          await updateUser(editingUser.id, body);
          await refreshApiUsers();
        } else {
          if (data.length >= 999) {
            alert('Đã đạt giới hạn tối đa 999 bản ghi. Vui lòng xóa một số dữ liệu trước!');
            setLoading(false);
            return;
          }
          await createUser({ username: formData.name, password: formData.password, email: formData.email, roleId: roleToId(formData.role) });
          await refreshApiUsers();
        }
      } else {
        // Fallback to local dataSdk
        if (editingUser) {
          const result = await window.dataSdk.update(userData);
          if (!result.isOk) {
            alert('Có lỗi xảy ra khi cập nhật người dùng!');
          }
        } else {
          if (data.length >= 999) {
            alert('Đã đạt giới hạn tối đa 999 bản ghi. Vui lòng xóa một số dữ liệu trước!');
            setLoading(false);
            return;
          }
          const result = await window.dataSdk.create(userData);
          if (!result.isOk) {
            alert('Có lỗi xảy ra khi tạo người dùng!');
          }
        }
      }

      setShowModal(false);
      setEditingUser(null);
      setFormData({
        name: '',
        email: '',
        role: 'student',
        password: '',
        status: 'active'
      });
    } catch (err) {
      console.error(err);
      alert('Có lỗi xảy ra!');
    }

    setLoading(false);
  };

  const handleEdit = (user) => {
    setEditingUser(user);
    setFormData({
      name: user.name,
      email: user.email,
      role: user.role,
      password: '',
      status: user.status
    });
    setShowModal(true);
  };

  const handleDelete = async (userItem) => {
    if (userItem.role === 'admin' && users.filter(u => u.role === 'admin').length <= 1) {
      alert('Không thể xóa quản trị viên cuối cùng!');
      return;
    }

    if (window.confirm('Bạn có chắc chắn muốn xóa người dùng này?')) {
      setLoading(true);
      try {
        if (user && user.role === 'admin') {
          await deleteUser(userItem.id);
          await refreshApiUsers();
        } else {
          const result = await window.dataSdk.delete(userItem);
          if (!result.isOk) {
            alert('Có lỗi xảy ra khi xóa người dùng!');
          }
        }
      } catch (err) {
        console.error(err);
        alert('Có lỗi xảy ra khi xóa người dùng!');
      }
      setLoading(false);
    }
  };

  const handleToggleStatus = async (userItem) => {
    if (userItem.role === 'admin' && userItem.status === 'active' && users.filter(u => u.role === 'admin' && u.status === 'active').length <= 1) {
      alert('Không thể vô hiệu hóa quản trị viên cuối cùng!');
      return;
    }

    setLoading(true);
    try {
      if (user && user.role === 'admin') {
        await toggleUserStatus(userItem.id);
        await refreshApiUsers();
      } else {
        const updatedUser = {
          ...userItem,
          status: userItem.status === 'active' ? 'inactive' : 'active',
          updatedAt: new Date().toISOString()
        };

        const result = await window.dataSdk.update(updatedUser);
        if (!result.isOk) {
          alert('Có lỗi xảy ra khi cập nhật trạng thái người dùng!');
        }
      }
    } catch (err) {
      console.error(err);
      alert('Có lỗi xảy ra khi cập nhật trạng thái người dùng!');
    }
    setLoading(false);
  };

  return (
    <div className="space-y-6 fade-in">
      <div className="flex items-center justify-between">
        <h1 className="text-3xl font-bold" style={{ color: config.text_color }}>
          Quản lý người dùng
        </h1>
        <div className="flex items-center space-x-3">
          <button
            onClick={() => setShowModal(true)}
            className="px-4 py-2 text-white rounded-lg hover:opacity-90 transition-opacity"
            style={{ backgroundColor: config.accent_color }}
          >
            Thêm người dùng
          </button>
          <button
            onClick={() => setShowBtcModal(true)}
            className="px-4 py-2 text-white rounded-lg hover:opacity-90 transition-opacity bg-gray-700"
          >
            Quản lý BTC
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow-md overflow-hidden">
        <div className="overflow-x-auto">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Người dùng
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Email
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Vai trò
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Trạng thái
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Thao tác
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.slice((page - 1) * itemsPerPage, page * itemsPerPage).map(user => (
                <tr key={user.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">
                      {user.name}
                    </div>
                    <div className="text-sm text-gray-500">
                      ID: {user.id}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    {user.email}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                      {roleOptions.find(r => r.value === user.role)?.label || user.role}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.status === 'active'
                        ? 'bg-green-100 text-green-800'
                        : 'bg-red-100 text-red-800'
                      }`}>
                      {user.status === 'active' ? 'Hoạt động' : 'Vô hiệu'}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                    <button
                      onClick={() => handleEdit(user)}
                      className="text-blue-600 hover:text-blue-900"
                    >
                      Sửa
                    </button>
                    <button
                      onClick={() => handleToggleStatus(user)}
                      className={`${user.status === 'active'
                          ? 'text-yellow-600 hover:text-yellow-900'
                          : 'text-green-600 hover:text-green-900'
                        }`}
                    >
                      {user.status === 'active' ? 'Vô hiệu' : 'Kích hoạt'}
                    </button>
                    <button
                      onClick={() => handleDelete(user)}
                      className="text-red-600 hover:text-red-900"
                    >
                      Xóa
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          {users.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              Chưa có người dùng nào
            </div>
          )}
          {/* Pagination controls */}
          {users.length > itemsPerPage && (
            <div className="flex items-center justify-center space-x-3 py-4">
              <button onClick={() => setPage(p => Math.max(1, p - 1))} className="px-3 py-1 bg-gray-100 rounded">Prev</button>
              {Array.from({ length: Math.ceil(users.length / itemsPerPage) }).map((_, idx) => (
                <button key={idx} onClick={() => setPage(idx + 1)} className={`px-3 py-1 rounded ${page === idx + 1 ? 'bg-blue-500 text-white' : 'bg-gray-100'}`}>{idx + 1}</button>
              ))}
              <button onClick={() => setPage(p => Math.min(Math.ceil(users.length / itemsPerPage), p + 1))} className="px-3 py-1 bg-gray-100 rounded">Next</button>
            </div>
          )}
        </div>
      </div>

      <Modal
        isOpen={showModal}
        onClose={() => {
          setShowModal(false);
          setEditingUser(null);
          setFormData({
            name: '',
            email: '',
            role: 'student',
            password: '',
            status: 'active'
          });
        }}
        title={editingUser ? 'Chỉnh sửa người dùng' : 'Thêm người dùng mới'}
        size="md"
      >
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Tên tài khoản *
            </label>
            <input
              type="text"
              required
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="Nhập họ tên"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              {editingUser ? 'Mật khẩu mới (để trống nếu không đổi)' : 'Mật khẩu *'}
            </label>
            <input
              type="password"
              required={!editingUser}
              value={formData.password}
              onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder={editingUser ? 'Nhập mật khẩu mới' : 'Nhập mật khẩu'}
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Vai trò *
            </label>
            <select
              required
              value={formData.role}
              onChange={(e) => setFormData({ ...formData, role: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              {roleOptions.map(role => (
                <option key={role.value} value={role.value}>
                  {role.label}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Email *
            </label>
            <input
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
              placeholder="Nhập email"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Trạng thái *
            </label>
            <select
              required
              value={formData.status}
              onChange={(e) => setFormData({ ...formData, status: e.target.value })}
              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
            >
              <option value="active">Hoạt động</option>
              <option value="inactive">Vô hiệu</option>
            </select>
          </div>

          <div className="flex justify-end space-x-3 pt-4">
            <button
              type="button"
              onClick={() => setShowModal(false)}
              className="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300"
            >
              Hủy
            </button>
            <button
              type="submit"
              disabled={loading}
              className="px-4 py-2 text-white rounded-md hover:opacity-90 disabled:opacity-50"
              style={{ backgroundColor: config.accent_color }}
            >
              {loading ? 'Đang xử lý...' : (editingUser ? 'Cập nhật' : 'Thêm người dùng')}
            </button>
          </div>
        </form>
      </Modal>

      {/* BTC groups management modal */}
      <Modal
        isOpen={showBtcModal}
        onClose={() => {
          setShowBtcModal(false);
          setEditingGroup(null);
        }}
        title={editingGroup ? 'Chỉnh sửa BTC' : 'Quản lý BTC (Ban tổ chức)'}
        size="lg"
      >
        <div className="space-y-4">
          <div>
            <button
              onClick={() => {
                // Create empty group editing state
                setEditingGroup({ id: null, title: '', eventId: '', members: [], judges: [] });
              }}
              className="px-3 py-2 bg-green-600 text-white rounded-md"
            >
              + Tạo BTC mới
            </button>
          </div>

          {/* List existing groups */}
          <div>
            {btcGroups.length === 0 && (
              <div className="text-sm text-gray-500">Chưa có BTC nào được tạo.</div>
            )}
            {btcGroups.map(group => (
              <div key={group.id} className="border rounded p-3 mb-2 flex justify-between items-center">
                <div>
                  <div className="font-medium">{group.title || 'BTC không tên'}</div>
                  <div className="text-sm text-gray-600">Sự kiện: {eventsList.find(ev => ev.id === group.eventId)?.title || 'N/A'}</div>
                  <div className="text-sm text-gray-600">Thành viên: {(group.members || []).length} | BGK: {(group.judges || []).length}</div>
                </div>
                <div className="space-x-2">
                  <button
                    onClick={() => {
                      setEditingGroup(group);
                    }}
                    className="px-2 py-1 text-sm bg-yellow-100 rounded"
                  >
                    Sửa
                  </button>
                  <button
                    onClick={async () => {
                      if (!window.confirm('Xóa BTC này?')) return;
                      setLoading(true);
                      const res = await window.dataSdk.delete(group);
                      if (!res.isOk) alert('Xóa thất bại');
                      setLoading(false);
                    }}
                    className="px-2 py-1 text-sm bg-red-100 rounded"
                  >
                    Xóa
                  </button>
                  <button
                    onClick={() => {
                      // Open manage judges if user is admin or member
                      setEditingGroup(group);
                    }}
                    className="px-2 py-1 text-sm bg-blue-100 rounded"
                  >
                    Chọn BGK
                  </button>
                </div>
              </div>
            ))}
          </div>

          {/* Edit/create group form */}
          {editingGroup && (
            <form
              onSubmit={async (e) => {
                e.preventDefault();
                setLoading(true);
                const groupData = {
                  id: editingGroup.id || generateId(),
                  type: 'btc_group',
                  title: editingGroup.title,
                  eventId: editingGroup.eventId,
                  members: editingGroup.members || [],
                  judges: editingGroup.judges || [],
                  createdBy: user.id,
                  createdAt: editingGroup.createdAt || new Date().toISOString(),
                  updatedAt: new Date().toISOString(),
                  data: JSON.stringify({})
                };

                try {
                  if (editingGroup.id) {
                    const result = await window.dataSdk.update(groupData);
                    if (!result.isOk) alert('Cập nhật BTC thất bại');
                  } else {
                    const result = await window.dataSdk.create(groupData);
                    if (!result.isOk) alert('Tạo BTC thất bại');
                  }
                  setEditingGroup(null);
                } catch {
                  alert('Có lỗi xảy ra khi lưu BTC');
                }
                setLoading(false);
              }}
              className="space-y-3"
            >
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Tên BTC *</label>
                <input
                  required
                  value={editingGroup.title}
                  onChange={(e) => setEditingGroup({ ...editingGroup, title: e.target.value })}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Sự kiện *</label>
                <select
                  required
                  value={editingGroup.eventId}
                  onChange={(e) => setEditingGroup({ ...editingGroup, eventId: e.target.value })}
                  className="w-full px-3 py-2 border rounded"
                >
                  <option value="">-- Chọn sự kiện --</option>
                  {eventsList.map(ev => (
                    <option key={ev.id} value={ev.id}>{ev.title}</option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Chọn thành viên (BTC)</label>
                <div className="max-h-40 overflow-auto border p-2">
                  {users.map(u => (
                    <label key={u.id} className="flex items-center space-x-2 text-sm mb-1">
                      <input
                        type="checkbox"
                        checked={(editingGroup.members || []).includes(u.id)}
                        onChange={(e) => {
                          const members = new Set(editingGroup.members || []);
                          if (e.target.checked) members.add(u.id); else members.delete(u.id);
                          setEditingGroup({ ...editingGroup, members: Array.from(members) });
                        }}
                      />
                      <span>{u.name} ({u.email})</span>
                    </label>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Chọn BGK (nếu cần)</label>
                <div className="max-h-40 overflow-auto border p-2">
                  {users.map(u => (
                    <label key={u.id} className="flex items-center space-x-2 text-sm mb-1">
                      <input
                        type="checkbox"
                        checked={(editingGroup.judges || []).includes(u.id)}
                        onChange={(e) => {
                          const judges = new Set(editingGroup.judges || []);
                          if (e.target.checked) judges.add(u.id); else judges.delete(u.id);
                          setEditingGroup({ ...editingGroup, judges: Array.from(judges) });
                        }}
                      />
                      <span>{u.name} ({u.email})</span>
                    </label>
                  ))}
                </div>
              </div>

              <div className="flex justify-end space-x-3 pt-2">
                <button
                  type="button"
                  onClick={() => setEditingGroup(null)}
                  className="px-3 py-2 bg-gray-200 rounded"
                >Hủy</button>
                <button type="submit" disabled={loading} className="px-3 py-2 bg-blue-600 text-white rounded">Lưu</button>
              </div>
            </form>
          )}
        </div>
      </Modal>
    </div>
  );
}