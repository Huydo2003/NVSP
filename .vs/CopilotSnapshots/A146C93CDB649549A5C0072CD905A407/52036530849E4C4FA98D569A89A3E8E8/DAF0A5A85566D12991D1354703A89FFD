const express = require('express');
const jwt = require('jsonwebtoken');
const cors = require('cors');
require('dotenv').config();

const pool = require('./db');
const auth = require('./auth');

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 4000;
const JWT_SECRET = process.env.JWT_SECRET || 'dev-secret';

app.get('/api/ping', (req, res) => res.json({ ok: true, ts: Date.now() }));

// POST /api/login
// body: { username, password }
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body || {};
    if (!username || !password) return res.status(400).json({ message: 'username and password required' });

    const [rows] = await pool.execute('SELECT * FROM taikhoan WHERE tenTK = ? LIMIT 1', [username]);
    if (!rows || rows.length === 0) return res.status(401).json({ message: 'Invalid credentials' });

    const user = rows[0];

    // check trang_thai (active account)
    if (user.trang_thai !== null && user.trang_thai !== undefined && Number(user.trang_thai) !== 1) {
      return res.status(403).json({ message: 'Account is inactive' });
    }

    const stored = user.matKhau || '';
    const passwordMatches = password === stored;

    if (!passwordMatches) return res.status(401).json({ message: 'Invalid credentials' });

    const payload = {
      id: user.Id,
      username: user.tenTK,
      roleId: user.id_loaiTK || null,
    };

    const token = jwt.sign(payload, JWT_SECRET, { expiresIn: '8h' });

    // optionally fetch role name
    let roleName = null;
    try {
      const [r] = await pool.execute('SELECT tenLoaiTK FROM loaitaikhoan WHERE Id_loaiTK = ? LIMIT 1', [payload.roleId]);
      if (r && r.length) roleName = r[0].tenLoaiTK;
    } catch (err) {
      // ignore role fetch error
    }

    const safeUser = {
      id: user.Id,
      username: user.tenTK,
      email: user.email,
      roleId: payload.roleId,
      roleName,
      createdAt: user.ngay_tao || null,
    };

    res.json({ token, user: safeUser });
  } catch (err) {
    console.error('Login error', err);
    res.status(500).json({ message: 'Server error' });
  }
});

// Protected route example
app.get('/api/me', auth, async (req, res) => {
  try {
    const userId = req.user && req.user.id;
    if (!userId) return res.status(401).json({ message: 'Invalid token payload' });
    const [rows] = await pool.execute('SELECT Id, tenTK, email, id_loaiTK, trang_thai, ngay_tao FROM taikhoan WHERE Id = ? LIMIT 1', [userId]);
    if (!rows || rows.length === 0) return res.status(404).json({ message: 'User not found' });

    const u = rows[0];

    // Fetch role name in Vietnamese
    let roleName = null;
    try {
      const [r] = await pool.execute('SELECT tenLoaiTK FROM loaitaikhoan WHERE Id_loaiTK = ? LIMIT 1', [u.id_loaiTK]);
      if (r && r.length) {
        roleName = r[0].tenLoaiTK;
        // Map technical names to display names if needed
        const roleDisplayNames = {
          'Admin': 'Quản trị viên',
          'BanToChuc': 'Ban tổ chức',
          'CanBoLop': 'Cán bộ lớp',
          'SinhVien': 'Sinh viên',
          'GiamKhao': 'Giám khảo'
        };
        roleName = roleDisplayNames[roleName] || roleName;
      }
    } catch (err) {
      // ignore
    }

    res.json({ id: u.Id, username: u.tenTK, email: u.email, roleId: u.id_loaiTK, roleName, active: u.trang_thai, createdAt: u.ngay_tao });
  } catch (err) {
    console.error('GET /api/me error', err);
    res.status(500).json({ message: 'Server error' });
  }
});

// User Management Routes (Admin only)
app.get('/api/users', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const [rows] = await pool.execute(`
      SELECT t.Id, t.tenTK, t.email, t.id_loaiTK, t.trang_thai, t.ngay_tao,
             lt.tenLoaiTK as roleName
      FROM taikhoan t 
      LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK 
      ORDER BY t.Id DESC
    `);

    res.json(rows.map(u => ({
      id: u.Id,
      username: u.tenTK,
      email: u.email,
      roleId: u.id_loaiTK,
      roleName: u.roleName,
      active: u.trang_thai,
      createdAt: u.ngay_tao
    })));
  } catch (err) {
    console.error('GET /api/users error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/users', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    let { username, password, email, roleId } = req.body || {};
    if (!username || !password || !email || (roleId === undefined || roleId === null)) {
      return res.status(400).json({ message: 'Thiếu thông tin bắt buộc' });
    }

    // normalize roleId to number when possible
    roleId = Number(roleId) || roleId;

    // Check username/email exists
    const [existing] = await pool.execute('SELECT Id FROM taikhoan WHERE tenTK = ? OR email = ?', [username, email]);
    if (existing && existing.length > 0) {
      return res.status(400).json({ message: 'Tên đăng nhập hoặc email đã tồn tại' });
    }

    // Store password as plain text per request
    const [result] = await pool.execute(
      'INSERT INTO taikhoan (tenTK, matKhau, email, id_loaiTK, trang_thai, ngay_tao) VALUES (?, ?, ?, ?, 1, NOW())',
      [username, password, email, roleId]
    );

    if (result.insertId) {
      const [rows] = await pool.execute(
        'SELECT t.*, lt.tenLoaiTK as roleName FROM taikhoan t LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK WHERE t.Id = ?',
        [result.insertId]
      );
      
      const user = rows[0];
      res.json({
        id: user.Id,
        username: user.tenTK,
        email: user.email,
        roleId: user.id_loaiTK,
        roleName: user.roleName,
        active: user.trang_thai,
        createdAt: user.ngay_tao
      });
    } else {
      throw new Error('Failed to create user');
    }
  } catch (err) {
    console.error('POST /api/users error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.put('/api/users/:id', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    let { email, roleId, password } = req.body || {};

    // ensure user exists
    const [existingUserRows] = await pool.execute('SELECT Id, id_loaiTK FROM taikhoan WHERE Id = ?', [id]);
    if (!existingUserRows || existingUserRows.length === 0) {
      return res.status(404).json({ message: 'Người dùng không tồn tại' });
    }

    // Don't allow editing admin if not self
    if (Number(id) !== req.user.id) {
      const targetRole = existingUserRows[0].id_loaiTK;
      if (targetRole === 1) {
        return res.status(403).json({ message: 'Không thể sửa tài khoản admin khác' });
      }
    }

    // Check email exists (except self)
    if (email) {
      const [ex] = await pool.execute('SELECT Id FROM taikhoan WHERE email = ? AND Id != ?', [email, id]);
      if (ex && ex.length > 0) {
        return res.status(400).json({ message: 'Email đã được sử dụng' });
      }
    }

    const updates = [];
    const params = [];

    if (email) {
      updates.push('email = ?');
      params.push(email);
    }
    if (roleId !== undefined && roleId !== null) {
      updates.push('id_loaiTK = ?');
      params.push(Number(roleId));
    }
    if (password) {
      // Store plain password
      updates.push('matKhau = ?');
      params.push(password);
    }

    if (updates.length === 0) {
      return res.status(400).json({ message: 'Không có thông tin cần cập nhật' });
    }

    params.push(id);
    await pool.execute(`UPDATE taikhoan SET ${updates.join(', ')} WHERE Id = ?`, params);

    const [rows] = await pool.execute(
      'SELECT t.*, lt.tenLoaiTK as roleName FROM taikhoan t LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK WHERE t.Id = ?',
      [id]
    );
    
    const user = rows[0];
    res.json({
      id: user.Id,
      username: user.tenTK,
      email: user.email,
      roleId: user.id_loaiTK,
      roleName: user.roleName,
      active: user.trang_thai,
      createdAt: user.ngay_tao
    });
  } catch (err) {
    console.error('PUT /api/users/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.delete('/api/users/:id', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    
    // Don't allow deleting self or other admins
    if (Number(id) === req.user.id) {
      return res.status(400).json({ message: 'Không thể xóa tài khoản đang đăng nhập' });
    }

    const [check] = await pool.execute('SELECT id_loaiTK FROM taikhoan WHERE Id = ?', [id]);
    if (!check || check.length === 0) {
      return res.status(404).json({ message: 'Người dùng không tồn tại' });
    }
    if (check[0].id_loaiTK === 1) {
      return res.status(403).json({ message: 'Không thể xóa tài khoản admin khác' });
    }

    await pool.execute('DELETE FROM taikhoan WHERE Id = ?', [id]);
    res.json({ message: 'Đã xóa tài khoản' });
  } catch (err) {
    console.error('DELETE /api/users/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/users/:id/toggle-status', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    
    // Don't allow toggling self or other admins
    if (Number(id) === req.user.id) {
      return res.status(400).json({ message: 'Không thể vô hiệu hóa tài khoản đang đăng nhập' });
    }

    const [check] = await pool.execute('SELECT id_loaiTK, trang_thai FROM taikhoan WHERE Id = ?', [id]);
    if (!check || check.length === 0) {
      return res.status(404).json({ message: 'Người dùng không tồn tại' });
    }
    if (check[0].id_loaiTK === 1) {
      return res.status(403).json({ message: 'Không thể vô hiệu hóa tài khoản admin khác' });
    }

    const currentStatus = Number(check[0].trang_thai) === 1 ? 1 : 0;
    const newStatus = currentStatus === 1 ? 0 : 1;
    await pool.execute(
      'UPDATE taikhoan SET trang_thai = ? WHERE Id = ?',
      [newStatus, id]
    );

    const [rows] = await pool.execute(
      'SELECT t.*, lt.tenLoaiTK as roleName FROM taikhoan t LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK WHERE t.Id = ?',
      [id]
    );
    
    const user = rows[0];
    res.json({
      id: user.Id,
      username: user.tenTK,
      email: user.email,
      roleId: user.id_loaiTK,
      roleName: user.roleName,
      active: user.trang_thai,
      createdAt: user.ngay_tao
    });
  } catch (err) {
    console.error('POST /api/users/:id/toggle-status error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.listen(PORT, () => {
  console.log(`NVSP auth server listening on http://localhost:${PORT}`);
});
