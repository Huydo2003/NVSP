/**
 * Navigation.jsx - Menu điều hướng
 * 
 * Chức năng:
 * - Hiển thị menu theo vai trò
 * - Quản lý chuyển trang
 * - Hiển thị thông tin người dùng
 * - Xử lý đăng xuất
 */

import { useApp } from '../hooks/useApp';
import { useEffect, useState } from 'react';
import { apiFetch } from '../services/api';

export default function Navigation({ activeTab, setActiveTab, user, onLogout }) {
  const { state } = useApp();
  const { config } = state;
  const [isBcn, setIsBcn] = useState(false);

  useEffect(() => {
    let mounted = true;
    (async () => {
      try {
        if (!user) {
          if (mounted) setIsBcn(false);
          return;
        }
        const res = await apiFetch('/api/me/is_bcn');
        if (mounted) setIsBcn(!!res?.isBcn);
      } catch (err) {
        if (mounted) setIsBcn(false);
      }
    })();
    return () => { mounted = false; };
  }, [user]);

  const getMenuItems = () => {
    const baseItems = [
      { id: 'account', label: 'Tài khoản' }
    ];

    const role = String(user.role || '').toLowerCase();

    if (role === 'admin') {
      return [
        ...baseItems,
        { id: 'users', label: 'Quản lý người dùng' },
        { id: 'giang_vien', label: 'Quản lý giảng viên' },
        { id: 'sinh_vien', label: 'Quản lý sinh viên' },
        { id: 'bcn_khoa', label: 'Quản lý BCN Khoa' }
      ];
    }

    if (isBcn) {
      return [
        ...baseItems,
        { id: 'ban_to_chuc', label: 'Quản lý Ban tổ chức' },
        { id: 'can_bo_lop', label: 'Quản lý Cán bộ lớp' }
      ];
    }

    return baseItems;
  };

  return (
    <nav className="gradient-bg text-white w-64 min-h-full p-4 slide-in">
      <div className="mb-8">
        <h1 className="text-xl font-bold mb-2">{config.system_title}</h1>
        <div className="text-sm opacity-90">
          <p>{user?.username || user?.name || 'Người dùng'}</p>
          <p className="text-xs">{user?.email}</p>
        </div>
      </div>
      
      <ul className="space-y-2">
        {getMenuItems().map(item => (
          <li key={item.id}>
            <button
              onClick={() => setActiveTab(item.id)}
              className={`nav-item w-full text-left px-3 py-2 ${
                activeTab === item.id ? 'active' : ''
              }`}
            >
              <span>{item.label}</span>
            </button>
          </li>
        ))}
      </ul>
      
      <div className="mt-8 pt-4 border-t border-white/20">
        <button
          onClick={onLogout}
          className="nav-item w-full text-left px-3 py-2 text-red-200 hover:text-white"
        >
          <span>Đăng xuất</span>
        </button>
      </div>
    </nav>
  );
}