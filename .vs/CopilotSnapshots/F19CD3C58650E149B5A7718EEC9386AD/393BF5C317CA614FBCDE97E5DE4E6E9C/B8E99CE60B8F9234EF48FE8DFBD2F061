import { useState } from 'react';
import { useApp } from '../hooks/useApp';
import { login as apiLogin } from '../services/auth';
import { changePassword as apiChangePassword } from '../services/users';
import Modal from './Modal';
import toast from 'react-hot-toast';

/**
 * LoginForm.jsx - Đăng nhập hệ thống
 * 
 * Chức năng:
 * - Xác thực người dùng
 * - Kiểm tra quyền truy cập
 * - Quản lý phiên đăng nhập
 * - Yêu cầu đổi mật khẩu lần đầu cho tài khoản non-admin do Admin tạo
 */

export default function LoginForm({ onLogin }) {
  const [credentials, setCredentials] = useState({ ma_ca_nhan: '', mat_khau: '' });
  const [loading, setLoading] = useState(false);

  // change-password flow
  const [showChangeModal, setShowChangeModal] = useState(false);
  const [pendingUser, setPendingUser] = useState(null);
  const [passwords, setPasswords] = useState({ currentPassword: '', newPassword: '', confirmPassword: '' });
  const [changing, setChanging] = useState(false);
  const [forceChange, setForceChange] = useState(false);

  const { state } = useApp();
  const { config } = state;

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const res = await apiLogin(credentials.ma_ca_nhan, credentials.mat_khau);
      if (res && res.token && res.user) {
        // If non-admin and server indicates mustChangePassword -> force change
        if (res.user.mustChangePassword && res.user.role !== 'admin') {
          setPendingUser(res.user);
          setPasswords({ currentPassword: credentials.mat_khau, newPassword: '', confirmPassword: '' });
          setForceChange(true);
          setShowChangeModal(true);
          // Do not call onLogin yet; user must change password first
        } else {
          onLogin(res.user);
        }
      } else {
        toast.error(res && res.message ? res.message : 'Đăng nhập không thành công');
      }
    } catch (err) {
      console.error('Login error', err);
      const msg = err && err.body && err.body.message ? err.body.message : (err && err.message ? err.message : 'Lỗi đăng nhập');
      toast.error(msg);
    } finally {
      setLoading(false);
    }
  };

  const handleChangePassword = async (e) => {
    e.preventDefault();
    if (!pendingUser) return;
    if (!passwords.newPassword) return toast.error('Vui lòng nhập mật khẩu mới');
    if (passwords.newPassword !== passwords.confirmPassword) return toast.error('Mật khẩu xác nhận không khớp');

    setChanging(true);
    try {
      // call change-password endpoint using current stored token (apiLogin stored it earlier)
      await apiChangePassword(pendingUser.id, passwords.currentPassword, passwords.newPassword);
      toast.success('Đổi mật khẩu thành công, đang đăng nhập lại...');

      // re-login with new password to get fresh token and user
      const relogin = await apiLogin(pendingUser.ma_ca_nhan || pendingUser.ma_ca_nhan, passwords.newPassword);
      if (relogin && relogin.token && relogin.user) {
        setShowChangeModal(false);
        setForceChange(false);
        setPendingUser(null);
        onLogin(relogin.user);
      } else {
        // If re-login failed, clear local storage and show message
        localStorage.removeItem('nvsp_token');
        localStorage.removeItem('nvsp_user');
        toast.error('Đăng nhập lại không thành công, vui lòng đăng nhập lại');
      }
    } catch (err) {
      console.error('Change password error', err);
      const msg = err && err.body && err.body.message ? err.body.message : (err && err.message ? err.message : 'Lỗi khi đổi mật khẩu');
      toast.error(msg);
    } finally {
      setChanging(false);
    }
  };

  return (
    <div className="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" style={{ backgroundColor: config.background_color }}>
      <div className="max-w-md w-full space-y-8">
        <div className="text-center">
          <h2 className="mt-6 text-3xl font-extrabold" style={{ color: config.text_color }}>
            {config.system_title}
          </h2>
          <p className="mt-2 text-sm text-gray-600">
            Đăng nhập để truy cập hệ thống
          </p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div className="bg-white rounded-lg shadow-lg p-6">
            <div className="space-y-4">
              <div>
                <label htmlFor="ma_ca_nhan" className="block text-sm font-medium text-gray-700">
                  Mã cá nhân
                </label>
                <input
                  id="ma_ca_nhan"
                  name="ma_ca_nhan"
                  type="text"
                  required
                  className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Nhập mã cá nhân"
                  value={credentials.ma_ca_nhan}
                  onChange={(e) => setCredentials({...credentials, ma_ca_nhan: e.target.value})}
                />
              </div>
              <div>
                <label htmlFor="mat_khau" className="block text-sm font-medium text-gray-700">
                  Mật khẩu
                </label>
                <input
                  id="mat_khau"
                  name="mat_khau"
                  type="password"
                  required
                  className="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                  placeholder="Nhập mật khẩu"
                  value={credentials.mat_khau}
                  onChange={(e) => setCredentials({...credentials, mat_khau: e.target.value})}
                />
              </div>
            </div>
            <div className="mt-6">
              <button
                type="submit"
                disabled={loading}
                className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                style={{ backgroundColor: config.primary_color }}
              >
                {loading ? 'Đang đăng nhập...' : 'Đăng nhập'}
              </button>
            </div>
            <div className="mt-4 text-xs text-gray-500">
              <p>Tài khoản demo:</p>
              <p>admin/admin, giangvien/giangvien, cbl/cbl, student/student, judge/judge</p>
            </div>
          </div>
        </form>
      </div>

      <Modal
        isOpen={showChangeModal}
        onClose={() => {
          if (forceChange) {
            toast.error('Bạn phải đổi mật khẩu trước khi tiếp tục');
            return;
          }
          setShowChangeModal(false);
          setPendingUser(null);
        }}
        title="Yêu cầu đổi mật khẩu"
        size="sm"
      >
        <form onSubmit={handleChangePassword} className="space-y-3">
          <p className="text-sm text-gray-700">Tài khoản của bạn được tạo sẵn bởi quản trị viên. Vui lòng đổi mật khẩu lần đầu để tiếp tục.</p>
          <div>
            <label className="block text-sm text-gray-700">Mật khẩu hiện tại</label>
            <input
              type="password"
              value={passwords.currentPassword}
              onChange={(e) => setPasswords({...passwords, currentPassword: e.target.value})}
              className="w-full px-3 py-2 border rounded"
              disabled
            />
          </div>
          <div>
            <label className="block text-sm text-gray-700">Mật khẩu mới</label>
            <input
              type="password"
              value={passwords.newPassword}
              onChange={(e) => setPasswords({...passwords, newPassword: e.target.value})}
              className="w-full px-3 py-2 border rounded"
            />
          </div>
          <div>
            <label className="block text-sm text-gray-700">Xác nhận mật khẩu mới</label>
            <input
              type="password"
              value={passwords.confirmPassword}
              onChange={(e) => setPasswords({...passwords, confirmPassword: e.target.value})}
              className="w-full px-3 py-2 border rounded"
            />
          </div>
          <div className="flex justify-end space-x-2">
            <button type="button" onClick={() => { if (!forceChange) { setShowChangeModal(false); setPendingUser(null); } }} className="px-3 py-1 bg-gray-200 rounded">Hủy</button>
            <button type="submit" disabled={changing} className="px-3 py-1 bg-blue-600 text-white rounded">{changing ? 'Đang xử lý...' : 'Đổi mật khẩu'}</button>
          </div>
        </form>
      </Modal>
    </div>
  );
}