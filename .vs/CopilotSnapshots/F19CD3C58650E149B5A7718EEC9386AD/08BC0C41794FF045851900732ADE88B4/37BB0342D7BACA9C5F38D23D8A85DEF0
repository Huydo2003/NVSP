const express = require('express');
const jwt = require('jsonwebtoken');
const cors = require('cors');
require('dotenv').config();

const pool = require('./db');
const auth = require('./auth');

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 4000;
const JWT_SECRET = process.env.JWT_SECRET || 'dev-secret';

app.get('/api/ping', (req, res) => res.json({ ok: true, ts: Date.now() }));

// POST /api/login
// body: { username, password }
app.post('/api/login', async (req, res) => {
  try {
    const { username, password } = req.body || {};
    if (!username || !password) return res.status(400).json({ message: 'username and password required' });

    const [rows] = await pool.execute('SELECT * FROM taikhoan WHERE tenTK = ? LIMIT 1', [username]);
    if (!rows || rows.length === 0) return res.status(401).json({ message: 'Invalid credentials' });

    const user = rows[0];

    // check trang_thai (active account)
    if (user.trang_thai !== null && user.trang_thai !== undefined && Number(user.trang_thai) !== 1) {
      return res.status(403).json({ message: 'Account is inactive' });
    }

    const stored = user.matKhau || '';
    const passwordMatches = password === stored;

    if (!passwordMatches) return res.status(401).json({ message: 'Invalid credentials' });

    const payload = {
      id: user.Id,
      username: user.tenTK,
      roleId: user.id_loaiTK || null,
    };

    const token = jwt.sign(payload, JWT_SECRET, { expiresIn: '8h' });

    // optionally fetch role name
    let roleName = null;
    try {
      const [r] = await pool.execute('SELECT tenLoaiTK FROM loaitaikhoan WHERE Id_loaiTK = ? LIMIT 1', [payload.roleId]);
      if (r && r.length) roleName = r[0].tenLoaiTK;
    // eslint-disable-next-line no-unused-vars
    } catch (err) {
      // ignore role fetch error
    }

    const safeUser = {
      id: user.Id,
      username: user.tenTK,
      email: user.email,
      roleId: payload.roleId,
      roleName,
      createdAt: user.ngay_tao || null,
      // require password change if not admin AND password hasn't been changed from default (username)
      mustChangePassword: (payload.roleId !== 1) && (user.matKhau === user.tenTK)
    };

    res.json({ token, user: safeUser });
  } catch (err) {
    console.error('Login error', err);
    res.status(500).json({ message: 'Server error' });
  }
});

// Protected route example
app.get('/api/me', auth, async (req, res) => {
  try {
    const userId = req.user && req.user.id;
    if (!userId) return res.status(401).json({ message: 'Invalid token payload' });
    const [rows] = await pool.execute('SELECT Id, tenTK, email, id_loaiTK, trang_thai, ngay_tao, matKhau FROM taikhoan WHERE Id = ? LIMIT 1', [userId]);
    if (!rows || rows.length === 0) return res.status(404).json({ message: 'User not found' });

    const u = rows[0];

    // Fetch role name in Vietnamese
    let roleName = null;
    try {
      const [r] = await pool.execute('SELECT tenLoaiTK FROM loaitaikhoan WHERE Id_loaiTK = ? LIMIT 1', [u.id_loaiTK]);
      if (r && r.length) {
        roleName = r[0].tenLoaiTK;
        // Map technical names to display names if needed
        const roleDisplayNames = {
          'Admin': 'Quản trị viên',
          'BanToChuc': 'Ban tổ chức',
          'CanBoLop': 'Cán bộ lớp',
          'SinhVien': 'Sinh viên',
          'GiamKhao': 'Giám khảo'
        };
        roleName = roleDisplayNames[roleName] || roleName;
      }
    // eslint-disable-next-line no-unused-vars
    } catch (err) {
      // ignore
    }

    const mustChangePassword = (u.id_loaiTK !== 1) && (u.matKhau === u.tenTK);

    res.json({ id: u.Id, username: u.tenTK, email: u.email, roleId: u.id_loaiTK, roleName, active: u.trang_thai, createdAt: u.ngay_tao, mustChangePassword });
  } catch (err) {
    console.error('GET /api/me error', err);
    res.status(500).json({ message: 'Server error' });
  }
});

// User Management Routes (Admin only)
app.get('/api/users', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const [rows] = await pool.execute(`
      SELECT t.Id, t.tenTK, t.email, t.id_loaiTK, t.trang_thai, t.ngay_tao,
             lt.tenLoaiTK as roleName
      FROM taikhoan t 
      LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK 
      ORDER BY t.Id DESC
    `);

    res.json(rows.map(u => ({
      id: u.Id,
      username: u.tenTK,
      email: u.email,
      roleId: u.id_loaiTK,
      roleName: u.roleName,
      active: u.trang_thai,
      createdAt: u.ngay_tao
    })));
  } catch (err) {
    console.error('GET /api/users error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/users', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    let { username, password, email, roleId } = req.body || {};
    if (!username || !email || (roleId === undefined || roleId === null)) {
      return res.status(400).json({ message: 'Thiếu thông tin bắt buộc' });
    }

    // normalize roleId to number when possible
    roleId = Number(roleId) || roleId;

    // If password not provided or empty, set password = username (user must change on first login)
    const finalPassword = (password && password.trim()) ? password : username;

    // Check username/email exists
    const [existing] = await pool.execute('SELECT Id FROM taikhoan WHERE tenTK = ? OR email = ?', [username, email]);
    if (existing && existing.length > 0) {
      return res.status(400).json({ message: 'Tên đăng nhập hoặc email đã tồn tại' });
    }

    // Store password as plain text per request
    const [result] = await pool.execute(
      'INSERT INTO taikhoan (tenTK, matKhau, email, id_loaiTK, trang_thai, ngay_tao) VALUES (?, ?, ?, ?, 1, NOW())',
      [username, finalPassword, email, roleId]
    );

    if (result.insertId) {
      const [rows] = await pool.execute(
        'SELECT t.*, lt.tenLoaiTK as roleName FROM taikhoan t LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK WHERE t.Id = ?',
        [result.insertId]
      );
      
      const user = rows[0];
      res.json({
        id: user.Id,
        username: user.tenTK,
        email: user.email,
        roleId: user.id_loaiTK,
        roleName: user.roleName,
        active: user.trang_thai,
        createdAt: user.ngay_tao
      });
    } else {
      throw new Error('Failed to create user');
    }
  } catch (err) {
    console.error('POST /api/users error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.put('/api/users/:id', auth, async (req, res) => {
  try {
    const { id } = req.params;
    // allow admin or the user themself to update
    if (req.user.roleId !== 1 && Number(req.user.id) !== Number(id)) return res.status(403).json({ message: 'Không có quyền truy cập' });

    let { username, email, roleId, password, currentPassword } = req.body || {};

    // ensure user exists
    const [existingUserRows] = await pool.execute('SELECT Id, id_loaiTK, matKhau FROM taikhoan WHERE Id = ?', [id]);
    if (!existingUserRows || existingUserRows.length === 0) {
      return res.status(404).json({ message: 'Người dùng không tồn tại' });
    }

    // Don't allow editing admin if not self
    if (Number(id) !== req.user.id) {
      const targetRole = existingUserRows[0].id_loaiTK;
      if (targetRole === 1) {
        return res.status(403).json({ message: 'Không thể sửa tài khoản admin khác' });
      }
    }

    // Check username exists (except self)
    if (username) {
      const [ux] = await pool.execute('SELECT Id FROM taikhoan WHERE tenTK = ? AND Id != ?', [username, id]);
      if (ux && ux.length > 0) {
        return res.status(400).json({ message: 'Tên đăng nhập đã được sử dụng' });
      }
    }

    // Check email exists (except self)
    if (email) {
      const [ex] = await pool.execute('SELECT Id FROM taikhoan WHERE email = ? AND Id != ?', [email, id]);
      if (ex && ex.length > 0) {
        return res.status(400).json({ message: 'Email đã được sử dụng' });
      }
    }

    const updates = [];
    const params = [];

    if (username) {
      updates.push('tenTK = ?');
      params.push(username);
    }
    if (email) {
      updates.push('email = ?');
      params.push(email);
    }
    // Only admin can change roleId
    if (roleId !== undefined && roleId !== null) {
      if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền cập nhật vai trò' });
      updates.push('id_loaiTK = ?');
      params.push(Number(roleId));
    }
    if (password) {
      // If the user is updating their own password and provided currentPassword, verify it
      if (Number(req.user.id) === Number(id) && currentPassword) {
        const stored = existingUserRows[0].matKhau || '';
        if (currentPassword !== stored) {
          return res.status(400).json({ message: 'Mật khẩu hiện tại không đúng' });
        }
      }
      updates.push('matKhau = ?');
      params.push(password);
    }

    if (updates.length === 0) {
      return res.status(400).json({ message: 'Không có thông tin cần cập nhật' });
    }

    params.push(id);
    await pool.execute(`UPDATE taikhoan SET ${updates.join(', ')} WHERE Id = ?`, params);

    const [rows] = await pool.execute(
      'SELECT t.*, lt.tenLoaiTK as roleName FROM taikhoan t LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK WHERE t.Id = ?',
      [id]
    );
    
    const user = rows[0];
    res.json({
      id: user.Id,
      username: user.tenTK,
      email: user.email,
      roleId: user.id_loaiTK,
      roleName: user.roleName,
      active: user.trang_thai,
      createdAt: user.ngay_tao
    });
  } catch (err) {
    console.error('PUT /api/users/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.delete('/api/users/:id', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    
    // Don't allow deleting self or other admins
    if (Number(id) === req.user.id) {
      return res.status(400).json({ message: 'Không thể xóa tài khoản đang đăng nhập' });
    }

    const [check] = await pool.execute('SELECT id_loaiTK FROM taikhoan WHERE Id = ?', [id]);
    if (!check || check.length === 0) {
      return res.status(404).json({ message: 'Người dùng không tồn tại' });
    }
    if (check[0].id_loaiTK === 1) {
      return res.status(403).json({ message: 'Không thể xóa tài khoản admin khác' });
    }

    await pool.execute('DELETE FROM taikhoan WHERE Id = ?', [id]);
    res.json({ message: 'Đã xóa tài khoản' });
  } catch (err) {
    console.error('DELETE /api/users/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/users/:id/toggle-status', auth, async (req, res) => {
  try {
    if (req.user.roleId !== 1) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    
    // Don't allow toggling self or other admins
    if (Number(id) === req.user.id) {
      return res.status(400).json({ message: 'Không thể vô hiệu hóa tài khoản đang đăng nhập' });
    }

    const [check] = await pool.execute('SELECT id_loaiTK, trang_thai FROM taikhoan WHERE Id = ?', [id]);
    if (!check || check.length === 0) {
      return res.status(404).json({ message: 'Người dùng không tồn tại' });
    }
    if (check[0].id_loaiTK === 1) {
      return res.status(403).json({ message: 'Không thể vô hiệu hóa tài khoản admin khác' });
    }

    const currentStatus = Number(check[0].trang_thai) === 1 ? 1 : 0;
    const newStatus = currentStatus === 1 ? 0 : 1;
    await pool.execute(
      'UPDATE taikhoan SET trang_thai = ? WHERE Id = ?',
      [newStatus, id]
    );

    const [rows] = await pool.execute(
      'SELECT t.*, lt.tenLoaiTK as roleName FROM taikhoan t LEFT JOIN loaitaikhoan lt ON t.id_loaiTK = lt.Id_loaiTK WHERE t.Id = ?',
      [id]
    );
    
    const user = rows[0];
    res.json({
      id: user.Id,
      username: user.tenTK,
      email: user.email,
      roleId: user.id_loaiTK,
      roleName: user.roleName,
      active: user.trang_thai,
      createdAt: user.ngay_tao
    });
  } catch (err) {
    console.error('POST /api/users/:id/toggle-status error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Events (hoatdong) CRUD
// GET /api/events - list activities (mapped to front-end event model)
app.get('/api/events', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute(`
      SELECT h.Id_HoatDong as id,
             h.tenHoatDong as title,
             COALESCE(ht.quyChe, '') as description,
             h.ngayMoDki as startDate,
             h.ngayDongDki as endDate,
             h.DiaDiem as location,
             COALESCE(h.soThanhVienToiDa, 0) as maxParticipants,
             s.Id_SuKien as eventId,
             s.tenSukien as eventName,
             h.Thi as isCompetition,
             h.hinhThucDk as hinhThucDk,
             COUNT(d.Id_DangKi) as currentParticipants
      FROM hoatdong h
      LEFT JOIN hoatdongthi ht ON ht.id_HoatDong = h.Id_HoatDong
      LEFT JOIN sukien s ON h.idSuKien = s.Id_SuKien
      LEFT JOIN dangki d ON d.id_HoatDong = h.Id_HoatDong
      GROUP BY h.Id_HoatDong
      ORDER BY h.Id_HoatDong DESC
    `);

    const now = new Date();
    const mapped = (rows || []).map(r => {
      const start = r.startDate ? new Date(r.startDate) : null;
      const end = r.endDate ? new Date(r.endDate) : null;
      let status = 'draft';
      if (start && end) {
        if (now < start) status = 'draft';
        else if (now >= start && now <= end) status = 'open';
        else status = 'closed';
      }
      return {
        id: r.id,
        title: r.title,
        description: r.description,
        startDate: r.startDate,
        endDate: r.endDate,
        location: r.location,
        maxParticipants: Number(r.maxParticipants) || 0,
        currentParticipants: Number(r.currentParticipants) || 0,
        eventId: r.eventId || null,
        eventName: r.eventName || null,
        isCompetition: Number(r.isCompetition) === 1,
        hinhThucDk: r.hinhThucDk || null,
        status
      };
    });

    res.json(mapped);
  } catch (err) {
    console.error('GET /api/events error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// list sukien (event types)
app.get('/api/sukien', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT Id_SuKien as id, tenSukien as name FROM sukien ORDER BY Id_SuKien DESC');
    res.json(rows.map(r => ({ id: r.id, name: r.name })));
  } catch (err) {
    console.error('GET /api/sukien error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// READ-only: Attendances (diemdanh)
app.get('/api/attendances', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute(`
      SELECT d.Id_DiemDanh as id,
             d.Id_HoatDongThamDu as hoatDongThamDuId,
             d.Id_SV as studentId,
             sv.idMSV as studentCode,
             sv.tenSV as studentName,
             d.thoigianCheckin as checkInTime,
             d.anhMinhChung as photo,
             d.Id_CBLDuyet as approvedBy,
             d.ThoiGianDuyet as approvedAt,
             d.LyDoTuChoi as rejectionReason
      FROM diemdanh d
      LEFT JOIN sinhvien sv ON d.Id_SV = sv.Id_SV
      ORDER BY d.Id_DiemDanh DESC
    `);

    const mapped = (rows || []).map(r => {
      let status = 'pending';
      if (r.rejectionReason) status = 'rejected';
      else if (r.approvedBy) status = 'approved';
      return {
        id: r.id,
        hoatDongThamDuId: r.hoatDongThamDuId,
        studentId: r.studentId,
        studentCode: r.studentCode,
        studentName: r.studentName,
        checkInTime: r.checkInTime,
        photo: r.photo,
        approvedBy: r.approvedBy,
        approvedAt: r.approvedAt,
        rejectionReason: r.rejectionReason,
        status
      };
    });

    res.json(mapped);
  } catch (err) {
    console.error('GET /api/attendances error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// READ-only: Registrations (dangki)
app.get('/api/registrations', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute(`
      SELECT d.Id_DangKi as id,
             d.id_HoatDong as eventId,
             h.tenHoatDong as eventTitle,
             d.idSV as studentId,
             sv.idMSV as studentCode,
             sv.tenSV as fullName,
             d.loaiDki as category,
             d.thoiGianDki as registrationDate,
             d.idCBLDuyet as approvedBy
      FROM dangki d
      LEFT JOIN sinhvien sv ON d.idSV = sv.Id_SV
      LEFT JOIN hoatdong h ON d.id_HoatDong = h.Id_HoatDong
      ORDER BY d.Id_DangKi DESC
    `);

    const mapped = (rows || []).map(r => ({
      id: r.id,
      eventId: r.eventId,
      eventTitle: r.eventTitle,
      studentId: r.studentId,
      studentCode: r.studentCode,
      fullName: r.fullName,
      category: r.category,
      registrationDate: r.registrationDate,
      approvedBy: r.approvedBy,
      status: r.approvedBy ? 'approved' : 'pending'
    }));

    res.json(mapped);
  } catch (err) {
    console.error('GET /api/registrations error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// READ-only: Competitions (hoatdongthi)
app.get('/api/competitions', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute(`
      SELECT ht.Id_HoatDongThi as id,
             h.Id_HoatDong as hoatDongId,
             h.tenHoatDong as title,
             ht.quyChe as description,
             ht.soDoiToiDa as maxParticipants,
             ht.linkDki as registrationUrl,
             ht.qrDki as qrCode
      FROM hoatdongthi ht
      LEFT JOIN hoatdong h ON ht.id_HoatDong = h.Id_HoatDong
      ORDER BY ht.Id_HoatDongThi DESC
    `);

    const mapped = (rows || []).map(r => ({
      id: r.id,
      hoatDongId: r.hoatDongId,
      title: r.title,
      description: r.description,
      maxParticipants: Number(r.maxParticipants) || 0,
      currentParticipants: 0,
      registrationUrl: r.registrationUrl || null,
      qrCode: r.qrCode || null
    }));

    res.json(mapped);
  } catch (err) {
    console.error('GET /api/competitions error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// READ-only: Certificates (chungnhan)
app.get('/api/certificates', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute(`
      SELECT c.Id_ChungNhan as id,
             c.Id_loaiCN as typeId,
             lc.tenloaiCN as typeName,
             c.Id_SV as studentId,
             sv.tenSV as studentName,
             c.Id_SuKien as eventId,
             s.tenSukien as eventName,
             c.Id_BTC as btcId
      FROM chungnhan c
      LEFT JOIN loaichungnhan lc ON c.Id_loaiCN = lc.Id_loaiCN
      LEFT JOIN sinhvien sv ON c.Id_SV = sv.Id_SV
      LEFT JOIN sukien s ON c.Id_SuKien = s.Id_SuKien
      ORDER BY c.Id_ChungNhan DESC
    `);

    const mapped = (rows || []).map(r => ({
      id: r.id,
      typeId: r.typeId,
      typeName: r.typeName,
      studentId: r.studentId,
      studentName: r.studentName,
      eventId: r.eventId,
      eventName: r.eventName,
      btcId: r.btcId,
      status: 'issued'
    }));

    res.json(mapped);
  } catch (err) {
    console.error('GET /api/certificates error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.get('/api/events/:id', auth, async (req, res) => {
  try {
    const { id } = req.params;
    const [rows] = await pool.execute(`
      SELECT h.Id_HoatDong as id,
             h.tenHoatDong as title,
             COALESCE(ht.quyChe, '') as description,
             h.ngayMoDki as startDate,
             h.ngayDongDki as endDate,
             h.DiaDiem as location,
             COALESCE(h.soThanhVienToiDa, 0) as maxParticipants,
             s.Id_SuKien as eventId,
             s.tenSukien as eventName,
             h.Thi as isCompetition,
             h.hinhThucDk as hinhThucDk,
             (SELECT COUNT(*) FROM dangki d WHERE d.id_HoatDong = h.Id_HoatDong) as currentParticipants
      FROM hoatdong h
      LEFT JOIN hoatdongthi ht ON ht.id_HoatDong = h.Id_HoatDong
      LEFT JOIN sukien s ON h.idSuKien = s.Id_SuKien
      WHERE h.Id_HoatDong = ?
      LIMIT 1
    `, [id]);

    if (!rows || rows.length === 0) return res.status(404).json({ message: 'Sự kiện không tồn tại' });
    const r = rows[0];
    const now = new Date();
    const start = r.startDate ? new Date(r.startDate) : null;
    const end = r.endDate ? new Date(r.endDate) : null;
    let status = 'draft';
    if (start && end) {
      if (now < start) status = 'draft';
      else if (now >= start && now <= end) status = 'open';
      else status = 'closed';
    }

    res.json({
      id: r.id,
      title: r.title,
      description: r.description,
      startDate: r.startDate,
      endDate: r.endDate,
      location: r.location,
      maxParticipants: Number(r.maxParticipants) || 0,
      currentParticipants: Number(r.currentParticipants) || 0,
      eventId: r.eventId || null,
      eventName: r.eventName || null,
      isCompetition: Number(r.isCompetition) === 1,
      hinhThucDk: r.hinhThucDk || null,
      status
    });
  } catch (err) {
    console.error('GET /api/events/:id error', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Create event (hoatdong)
app.post('/api/events', auth, async (req, res) => {
  try {
    // only Admin(1) and BanToChuc(2) can create
    if (![1, 2].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { title, description, startDate, endDate, location, maxParticipants, eventId, hinhThucDk, isCompetition } = req.body || {};
    if (!title) return res.status(400).json({ message: 'Tên sự kiện là bắt buộc' });

    const [result] = await pool.execute(
      'INSERT INTO hoatdong (tenHoatDong, idSuKien, hinhThucDk, soThanhVienToiDa, DiaDiem, Thi, ngayMoDki, ngayDongDki) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
      [title, eventId || null, hinhThucDk || null, maxParticipants || 0, location || null, isCompetition ? 1 : 0, startDate || null, endDate || null]
    );

    const newId = result.insertId;
    if (description) {
      await pool.execute('INSERT INTO hoatdongthi (id_HoatDong, quyChe) VALUES (?, ?)', [newId, description]);
    }

    // return created record
    const [rows] = await pool.execute(
      `SELECT h.Id_HoatDong as id, h.tenHoatDong as title, COALESCE(ht.quyChe,'') as description, h.ngayMoDki as startDate, h.ngayDongDki as endDate, h.DiaDiem as location, COALESCE(h.soThanhVienToiDa, 0) as maxParticipants, s.Id_SuKien as eventId, s.tenSukien as eventName, h.Thi as isCompetition, h.hinhThucDk as hinhThucDk, 0 as currentParticipants FROM hoatdong h LEFT JOIN hoatdongthi ht ON ht.id_HoatDong = h.Id_HoatDong LEFT JOIN sukien s ON h.idSuKien = s.Id_SuKien WHERE h.Id_HoatDong = ? LIMIT 1`,
      [newId]
    );

    const r = rows[0];
    res.json({ id: r.id, title: r.title, description: r.description, startDate: r.startDate, endDate: r.endDate, location: r.location, maxParticipants: Number(r.maxParticipants)||0, currentParticipants: 0, eventId: r.eventId, eventName: r.eventName, isCompetition: Number(r.isCompetition)===1, hinhThucDk: r.hinhThucDk || null, status: 'draft' });
  } catch (err) {
    console.error('POST /api/events error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Update event
app.put('/api/events/:id', auth, async (req, res) => {
  try {
    if (![1, 2].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    const { title, description, startDate, endDate, location, maxParticipants, eventId, hinhThucDk, isCompetition } = req.body || {};

    const [existing] = await pool.execute('SELECT Id_HoatDong FROM hoatdong WHERE Id_HoatDong = ? LIMIT 1', [id]);
    if (!existing || existing.length === 0) return res.status(404).json({ message: 'Sự kiện không tồn tại' });

    const updates = [];
    const params = [];
    if (title !== undefined) { updates.push('tenHoatDong = ?'); params.push(title); }
    if (eventId !== undefined) { updates.push('idSuKien = ?'); params.push(eventId || null); }
    if (location !== undefined) { updates.push('DiaDiem = ?'); params.push(location); }
    if (maxParticipants !== undefined) { updates.push('soThanhVienToiDa = ?'); params.push(Number(maxParticipants) || 0); }
    if (startDate !== undefined) { updates.push('ngayMoDki = ?'); params.push(startDate || null); }
    if (endDate !== undefined) { updates.push('ngayDongDki = ?'); params.push(endDate || null); }
    if (hinhThucDk !== undefined) { updates.push('hinhThucDk = ?'); params.push(hinhThucDk || null); }
    if (isCompetition !== undefined) { updates.push('Thi = ?'); params.push(isCompetition ? 1 : 0); }

    if (updates.length > 0) {
      params.push(id);
      await pool.execute(`UPDATE hoatdong SET ${updates.join(', ')} WHERE Id_HoatDong = ?`, params);
    }

    // update or insert hoatdongthi.quyChe
    if (description !== undefined) {
      const [ht] = await pool.execute('SELECT Id_HoatDongThi FROM hoatdongthi WHERE id_HoatDong = ? LIMIT 1', [id]);
      if (ht && ht.length > 0) {
        await pool.execute('UPDATE hoatdongthi SET quyChe = ? WHERE id_HoatDong = ?', [description, id]);
      } else {
        await pool.execute('INSERT INTO hoatdongthi (id_HoatDong, quyChe) VALUES (?, ?)', [id, description]);
      }
    }

    // return updated
    const [rows] = await pool.execute(
      `SELECT h.Id_HoatDong as id, h.tenHoatDong as title, COALESCE(ht.quyChe,'') as description, h.ngayMoDki as startDate, h.ngayDongDki as endDate, h.DiaDiem as location, COALESCE(h.soThanhVienToiDa, 0) as maxParticipants, s.Id_SuKien as eventId, s.tenSukien as eventName, h.Thi as isCompetition, h.hinhThucDk as hinhThucDk, (SELECT COUNT(*) FROM dangki d WHERE d.id_HoatDong = h.Id_HoatDong) as currentParticipants FROM hoatdong h LEFT JOIN hoatdongthi ht ON ht.id_HoatDong = h.Id_HoatDong LEFT JOIN sukien s ON h.idSuKien = s.Id_SuKien WHERE h.Id_HoatDong = ? LIMIT 1`,
      [id]
    );

    if (!rows || rows.length === 0) return res.status(404).json({ message: 'Sự kiện không tồn tại' });
    const r = rows[0];
    // compute status
    const now = new Date();
    const start = r.startDate ? new Date(r.startDate) : null;
    const end = r.endDate ? new Date(r.endDate) : null;
    let status = 'draft';
    if (start && end) {
      if (now < start) status = 'draft';
      else if (now >= start && now <= end) status = 'open';
      else status = 'closed';
    }

    res.json({ id: r.id, title: r.title, description: r.description, startDate: r.startDate, endDate: r.endDate, location: r.location, maxParticipants: Number(r.maxParticipants)||0, currentParticipants: Number(r.currentParticipants)||0, eventId: r.eventId, eventName: r.eventName, isCompetition: Number(r.isCompetition)===1, hinhThucDk: r.hinhThucDk || null, status });
  } catch (err) {
    console.error('PUT /api/events/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Delete event
app.delete('/api/events/:id', auth, async (req, res) => {
  try {
    if (![1, 2].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });

    const { id } = req.params;
    // prevent delete if registrations exist
    const [regs] = await pool.execute('SELECT COUNT(*) as cnt FROM dangki WHERE id_HoatDong = ?', [id]);
    if (regs && regs[0] && Number(regs[0].cnt) > 0) {
      return res.status(400).json({ message: 'Không thể xóa sự kiện có đăng ký' });
    }

    await pool.execute('DELETE FROM hoatdongthi WHERE id_HoatDong = ?', [id]);
    await pool.execute('DELETE FROM hoatdong WHERE Id_HoatDong = ?', [id]);

    res.json({ message: 'Đã xóa sự kiện' });
  } catch (err) {
    console.error('DELETE /api/events/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Account Types (Loại Tài Khoản) CRUD
app.get('/api/account-types', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT Id_loaiTK, tenLoaiTK FROM loaitaikhoan ORDER BY Id_loaiTK');
    res.json(rows || []);
  } catch (err) {
    console.error('GET /api/account-types error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/account-types', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { tenLoaiTK } = req.body;
    if (!tenLoaiTK) return res.status(400).json({ message: 'Tên loại tài khoản là bắt buộc' });

    const [result] = await pool.execute('INSERT INTO loaitaikhoan (tenLoaiTK) VALUES (?)', [tenLoaiTK]);
    const [rows] = await pool.execute('SELECT Id_loaiTK, tenLoaiTK FROM loaitaikhoan WHERE Id_loaiTK = ?', [result.insertId]);
    
    res.status(201).json(rows[0]);
  } catch (err) {
    console.error('POST /api/account-types error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.put('/api/account-types/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    const { tenLoaiTK } = req.body;
    if (!tenLoaiTK) return res.status(400).json({ message: 'Tên loại tài khoản là bắt buộc' });

    await pool.execute('UPDATE loaitaikhoan SET tenLoaiTK = ? WHERE Id_loaiTK = ?', [tenLoaiTK, id]);
    const [rows] = await pool.execute('SELECT Id_loaiTK, tenLoaiTK FROM loaitaikhoan WHERE Id_loaiTK = ?', [id]);
    
    res.json(rows[0]);
  } catch (err) {
    console.error('PUT /api/account-types/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.delete('/api/account-types/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    await pool.execute('DELETE FROM loaitaikhoan WHERE Id_loaiTK = ?', [id]);
    
    res.json({ message: 'Đã xóa loại tài khoản' });
  } catch (err) {
    console.error('DELETE /api/account-types/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Event Types (Loại Sự Kiện) CRUD
app.get('/api/event-types', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT Id_LoaiSuKien, tenLoaiSuKien FROM loaisukien ORDER BY Id_LoaiSuKien');
    res.json(rows || []);
  } catch (err) {
    console.error('GET /api/event-types error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/event-types', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { tenLoaiSuKien } = req.body;
    if (!tenLoaiSuKien) return res.status(400).json({ message: 'Tên loại sự kiện là bắt buộc' });

    const [result] = await pool.execute('INSERT INTO loaisukien (tenLoaiSuKien) VALUES (?)', [tenLoaiSuKien]);
    const [rows] = await pool.execute('SELECT Id_LoaiSuKien, tenLoaiSuKien FROM loaisukien WHERE Id_LoaiSuKien = ?', [result.insertId]);
    
    res.status(201).json(rows[0]);
  } catch (err) {
    console.error('POST /api/event-types error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.put('/api/event-types/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    const { tenLoaiSuKien } = req.body;
    if (!tenLoaiSuKien) return res.status(400).json({ message: 'Tên loại sự kiện là bắt buộc' });

    await pool.execute('UPDATE loaisukien SET tenLoaiSuKien = ? WHERE Id_LoaiSuKien = ?', [tenLoaiSuKien, id]);
    const [rows] = await pool.execute('SELECT Id_LoaiSuKien, tenLoaiSuKien FROM loaisukien WHERE Id_LoaiSuKien = ?', [id]);
    
    res.json(rows[0]);
  } catch (err) {
    console.error('PUT /api/event-types/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.delete('/api/event-types/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    await pool.execute('DELETE FROM loaisukien WHERE Id_LoaiSuKien = ?', [id]);
    
    res.json({ message: 'Đã xóa loại sự kiện' });
  } catch (err) {
    console.error('DELETE /api/event-types/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Certificate Types (Loại Chứng Nhận) CRUD
app.get('/api/certificates', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT Id_loaiCN, tenloaiCN FROM loaichungnhan ORDER BY Id_loaiCN');
    res.json(rows || []);
  } catch (err) {
    console.error('GET /api/certificates error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/certificates', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { tenloaiCN } = req.body;
    if (!tenloaiCN) return res.status(400).json({ message: 'Tên loại chứng nhận là bắt buộc' });

    const [result] = await pool.execute('INSERT INTO loaichungnhan (tenloaiCN) VALUES (?)', [tenloaiCN]);
    const [rows] = await pool.execute('SELECT Id_loaiCN, tenloaiCN FROM loaichungnhan WHERE Id_loaiCN = ?', [result.insertId]);
    
    res.status(201).json(rows[0]);
  } catch (err) {
    console.error('POST /api/certificates error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.put('/api/certificates/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    const { tenloaiCN } = req.body;
    if (!tenloaiCN) return res.status(400).json({ message: 'Tên loại chứng nhận là bắt buộc' });

    await pool.execute('UPDATE loaichungnhan SET tenloaiCN = ? WHERE Id_loaiCN = ?', [tenloaiCN, id]);
    const [rows] = await pool.execute('SELECT Id_loaiCN, tenloaiCN FROM loaichungnhan WHERE Id_loaiCN = ?', [id]);
    
    res.json(rows[0]);
  } catch (err) {
    console.error('PUT /api/certificates/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.delete('/api/certificates/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    await pool.execute('DELETE FROM loaichungnhan WHERE Id_loaiCN = ?', [id]);
    
    res.json({ message: 'Đã xóa loại chứng nhận' });
  } catch (err) {
    console.error('DELETE /api/certificates/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

// Support Types (Loại Hỗ Trợ) CRUD
app.get('/api/support-types', auth, async (req, res) => {
  try {
    const [rows] = await pool.execute('SELECT Id_LoaiHt, tenLoaiHt FROM loaihotro ORDER BY Id_LoaiHt');
    res.json(rows || []);
  } catch (err) {
    console.error('GET /api/support-types error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.post('/api/support-types', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { tenLoaiHt } = req.body;
    if (!tenLoaiHt) return res.status(400).json({ message: 'Tên loại hỗ trợ là bắt buộc' });

    const [result] = await pool.execute('INSERT INTO loaihotro (tenLoaiHt) VALUES (?)', [tenLoaiHt]);
    const [rows] = await pool.execute('SELECT Id_LoaiHt, tenLoaiHt FROM loaihotro WHERE Id_LoaiHt = ?', [result.insertId]);
    
    res.status(201).json(rows[0]);
  } catch (err) {
    console.error('POST /api/support-types error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.put('/api/support-types/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    const { tenLoaiHt } = req.body;
    if (!tenLoaiHt) return res.status(400).json({ message: 'Tên loại hỗ trợ là bắt buộc' });

    await pool.execute('UPDATE loaihotro SET tenLoaiHt = ? WHERE Id_LoaiHt = ?', [tenLoaiHt, id]);
    const [rows] = await pool.execute('SELECT Id_LoaiHt, tenLoaiHt FROM loaihotro WHERE Id_LoaiHt = ?', [id]);
    
    res.json(rows[0]);
  } catch (err) {
    console.error('PUT /api/support-types/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.delete('/api/support-types/:id', auth, async (req, res) => {
  try {
    if (![1].includes(Number(req.user.roleId))) return res.status(403).json({ message: 'Không có quyền truy cập' });
    
    const { id } = req.params;
    await pool.execute('DELETE FROM loaihotro WHERE Id_LoaiHt = ?', [id]);
    
    res.json({ message: 'Đã xóa loại hỗ trợ' });
  } catch (err) {
    console.error('DELETE /api/support-types/:id error:', err);
    res.status(500).json({ message: 'Lỗi server' });
  }
});

app.listen(PORT, () => {
  console.log(`NVSP auth server listening on http://localhost:${PORT}`);
});
