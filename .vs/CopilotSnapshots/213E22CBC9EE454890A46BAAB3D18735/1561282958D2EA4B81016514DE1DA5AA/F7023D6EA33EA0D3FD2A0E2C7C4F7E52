import React, { useEffect, useState } from 'react';
import toast from 'react-hot-toast';
import Modal from './Modal';
import { fetchDiemDanh, exportApprovedDiemDanh } from '../services/diem-danh';
import { fetchHoatDongThamDu } from '../services/hoat-dong-tham-du';
import { apiFetch } from '../services/api';

export default function DiemDanhManagement() {
  const [activities, setActivities] = useState([]);
  const [records, setRecords] = useState([]);
  const [loading, setLoading] = useState(true);

  const [showRegModal, setShowRegModal] = useState(false);
  const [selectedActivity, setSelectedActivity] = useState(null);
  const [activityRecords, setActivityRecords] = useState([]);

  const [exportModal, setExportModal] = useState(false);
  const [exportFilename, setExportFilename] = useState('diem_danh_duyet.csv');
  const availableFields = ['id', 'ma_sv', 'ho_ten', 'ten_hd', 'id_hd_tham_du', 'thoi_gian', 'trang_thai', 'anh_minh_chung'];
  const [exportFields, setExportFields] = useState([...availableFields]);

  // Load data
  const loadData = async () => {
    setLoading(true);
    try {
      const [hdtd, dd] = await Promise.all([fetchHoatDongThamDu(), fetchDiemDanh()]);
      setActivities(Array.isArray(hdtd) ? hdtd : []);
      setRecords(Array.isArray(dd) ? dd : []);
    } catch (err) {
      console.error(err);
      toast.error('Không thể tải dữ liệu');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => { loadData(); }, []);

  // Chuyển blob/buffer sang data URL
  const convertBufferToBase64 = (blob) => {
    if (!blob) return null;
    if (blob?.data && Array.isArray(blob.data)) {
      try {
        const uint8 = new Uint8Array(blob.data);
        let binary = '';
        for (let i = 0; i < uint8.length; i++) binary += String.fromCharCode(uint8[i]);
        return `data:image/jpeg;base64,${btoa(binary)}`;
      } catch (e) { return null; }
    }
    if (typeof blob === 'string') {
      if (blob.startsWith('data:image')) return blob;
      if (/^[A-Za-z0-9+/=]+$/.test(blob)) return `data:image/jpeg;base64,${blob}`;
    }
    return null;
  };

  // Xem danh sách điểm danh của hoạt động
  const handleViewRecords = (activity) => {
    const rows = records.filter(r => String(r.id_hd) === String(activity.id_hd_tham_du));
    setActivityRecords(rows.map(r => ({ ...r, anh_preview: convertBufferToBase64(r.anh_minh_chung) })));
    setSelectedActivity(activity);
    setShowRegModal(true);
  };

  const handleApprove = async (record) => {
    try {
      await apiFetch(`/api/diem-danh/${record.id}`, { method: 'PUT', body: JSON.stringify({ trang_thai: 1 }) });
      toast.success('Đã duyệt');
      await loadData();
      handleViewRecords(selectedActivity);
    } catch (err) {
      console.error(err);
      toast.error('Duyệt thất bại');
    }
  };

  const handleReject = async (record) => {
    try {
      await apiFetch(`/api/diem-danh/${record.id}`, { method: 'PUT', body: JSON.stringify({ trang_thai: -1 }) });
      toast.success('Đã từ chối');
      await loadData();
      handleViewRecords(selectedActivity);
    } catch (err) {
      console.error(err);
      toast.error('Từ chối thất bại');
    }
  };

  const handleExport = async () => {
    try {
      const result = await exportApprovedDiemDanh({ filename: exportFilename, fields: exportFields });
      let blob = result?.blob || result;
      let filename = result?.filename || exportFilename;
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      toast.success('Đã xuất file CSV');
      setExportModal(false);
    } catch (err) {
      console.error(err);
      toast.error('Không thể xuất file');
    }
  };

  const getTrangThaiColor = (trang_thai) => {
    if (trang_thai === 1) return 'text-green-600 bg-green-50';
    if (trang_thai === -1) return 'text-red-600 bg-red-50';
    return 'text-yellow-600 bg-yellow-50';
  };

  const getTrangThaiText = (trang_thai) => {
    if (trang_thai === 1) return 'Đã duyệt';
    if (trang_thai === -1) return 'Từ chối';
    return 'Chưa duyệt';
  };

  if (loading) return <div className="p-6">Đang tải...</div>;

  return (
    <div className="p-6 space-y-6 fade-in">
      <div className="flex justify-between items-center mb-4">
        <h1 className="text-3xl font-bold">Quản lý Điểm Danh</h1>
        <div className="space-x-2">
          <button onClick={() => setExportModal(true)} className="px-3 py-1 bg-green-600 text-white rounded">Xuất CSV</button>
          <button onClick={loadData} className="px-3 py-1 bg-blue-600 text-white rounded">Tải lại</button>
        </div>
      </div>

      {activities.length === 0 ? (
        <div className="text-center py-8 text-gray-500">Chưa có hoạt động tham dự</div>
      ) : (
        <div className="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
          {activities.map(activity => {
            const totalRegs = records.filter(r => r.id_hd === activity.id_hd_tham_du).length;
            const approvedCount = records.filter(r => r.id_hd === activity.id_hd_tham_du && r.trang_thai === 1).length;
            const rejectedCount = records.filter(r => r.id_hd === activity.id_hd_tham_du && r.trang_thai === -1).length;
            const pendingCount = totalRegs - approvedCount - rejectedCount;

            return (
              <div key={activity.id_hd_tham_du} className="bg-white border rounded-lg shadow-sm p-4 flex flex-col justify-between">
                <div>
                  <h3 className="text-lg font-semibold text-gray-900">{activity.ten_hd}</h3>
                  <div className="text-xs text-gray-500 mb-2">ID: {activity.id_hd_tham_du}</div>
                  <div className="text-sm text-gray-600 mb-2">Thời gian: {activity.tg_bat_dau ? new Date(activity.tg_bat_dau).toLocaleString('vi-VN') : '—'}</div>

                  <div className="grid grid-cols-3 gap-2 text-xs">
                    <div className="bg-yellow-50 p-2 rounded text-center border border-yellow-200">
                      <div className="font-semibold text-yellow-700">{pendingCount}</div>
                      <div className="text-yellow-600">Chờ duyệt</div>
                    </div>
                    <div className="bg-green-50 p-2 rounded text-center border border-green-200">
                      <div className="font-semibold text-green-700">{approvedCount}</div>
                      <div className="text-green-600">Đã duyệt</div>
                    </div>
                    <div className="bg-red-50 p-2 rounded text-center border border-red-200">
                      <div className="font-semibold text-red-700">{rejectedCount}</div>
                      <div className="text-red-600">Từ chối</div>
                    </div>
                  </div>
                </div>

                <div className="mt-4 flex justify-end">
                  <button
                    onClick={() => handleViewRecords(activity)}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Xem danh sách ({totalRegs})
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Modal danh sách điểm danh */}
      <Modal isOpen={showRegModal} onClose={() => setShowRegModal(false)} title={`Danh sách điểm danh: ${selectedActivity?.ten_hd || ''}`} size="lg">
        <div className="space-y-2 max-h-96 overflow-y-auto">
          {activityRecords.length === 0 ? (
            <div className="text-center py-4 text-gray-500">Chưa có sinh viên nào điểm danh</div>
          ) : activityRecords.map(r => (
            <div key={r.id} className="bg-white border rounded p-3 flex items-center justify-between hover:bg-gray-50">
              <div>
                <div className="text-sm font-semibold">{r.ho_ten} ({r.ma_sv})</div>
                <div className="text-xs text-gray-500">{r.thoi_gian ? new Date(r.thoi_gian).toLocaleString('vi-VN') : ''}</div>
              </div>
              <div className="flex items-center space-x-2">
                <span className={`px-2 py-1 text-xs font-semibold rounded ${getTrangThaiColor(r.trang_thai)}`}>{getTrangThaiText(r.trang_thai)}</span>
                {r.trang_thai === 0 && (
                  <>
                    <button onClick={() => handleApprove(r)} className="px-3 py-1 text-xs bg-green-600 text-white rounded hover:bg-green-700">Duyệt</button>
                    <button onClick={() => handleReject(r)} className="px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700">Từ chối</button>
                  </>
                )}
              </div>
            </div>
          ))}
        </div>
      </Modal>

      {/* Modal xuất CSV */}
      <Modal isOpen={exportModal} onClose={() => setExportModal(false)} title="Tùy chọn xuất CSV" size="md">
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Tên file</label>
            <input value={exportFilename} onChange={e => setExportFilename(e.target.value)} className="w-full px-3 py-2 border rounded" />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Chọn cột</label>
            <div className="grid grid-cols-2 gap-2">
              {availableFields.map(f => (
                <label key={f} className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    checked={exportFields.includes(f)}
                    onChange={() => {
                      setExportFields(prev => prev.includes(f) ? prev.filter(x => x !== f) : [...prev, f]);
                    }}
                  />
                  <span className="text-sm">{f}</span>
                </label>
              ))}
            </div>
          </div>

          <div className="flex justify-end space-x-3">
            <button onClick={() => setExportModal(false)} className="px-3 py-2 bg-gray-200 rounded">Hủy</button>
            <button onClick={handleExport} className="px-3 py-2 bg-green-600 text-white rounded">Xuất</button>
          </div>
        </div>
      </Modal>
    </div>
  );
}
