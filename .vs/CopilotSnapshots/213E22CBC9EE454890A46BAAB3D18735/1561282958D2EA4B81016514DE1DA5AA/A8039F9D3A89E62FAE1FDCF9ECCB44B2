import { apiFetch } from './api';

export async function fetchDiemDanh() {
  return apiFetch('/api/diem-danh');
}

// accept optional ma_sv
export async function registerDiemDanh(id_hd_tham_du, anh_minh_chung, ma_sv) {
  const body = { id_hd_tham_du, anh_minh_chung };
  if (ma_sv) body.ma_sv = ma_sv;
  return apiFetch('/api/diem-danh', {
    method: 'POST',
    body: JSON.stringify(body)
  });
}

export async function cancelDiemDanh(id) {
  return apiFetch(`/api/diem-danh/${id}`, {
    method: 'DELETE'
  });
}

// New: export approved attendance CSV (returns Blob)
export async function exportApprovedDiemDanh(options = {}) {
  const { filename = 'diem_danh_duyet_v2.csv', fields = [], id_hd } = options || {};
  const base = window.__NVSP_API_BASE__ || '';
  const token = localStorage.getItem('nvsp_token');
  const params = new URLSearchParams();
  if (filename) params.set('filename', filename);
  if (Array.isArray(fields) && fields.length > 0) params.set('fields', fields.join(','));
  if (typeof id_hd !== 'undefined' && id_hd !== null) params.set('id_hd', id_hd);
  const url = (base ? base : '') + '/api/diem-danh/export' + (params.toString() ? `?${params.toString()}` : '');
  const res = await fetch(url, { headers: { Authorization: token ? `Bearer ${token}` : '' } });
  if (!res.ok) throw new Error('Export thất bại');
  return res.blob();
}
